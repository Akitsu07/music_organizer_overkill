<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for Android Status Bar -->
    <meta name="theme-color" content="#0a0a0a">
    <title>Music Grid Organizer</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --accent-primary: #007aff; /* Bold Blue */
            --accent-secondary: #34c759; /* Green for checked */
            --border-color: #3a3a3c;
            --shadow-color: rgba(0,0,0,0.7);
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            overflow: hidden;
            padding: 16px;
            gap: 16px;
        }

        .header {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
            transition: padding 0.4s ease;
        }
        
        .header-title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        #header-toggle-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5em;
            cursor: pointer;
            transition: transform 0.4s ease;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 16px;
            overflow: hidden;
            max-height: 500px; /* Large enough to not clip content */
            transition: max-height 0.4s ease-in-out, margin-top 0.4s ease-in-out;
        }
        
        /* Collapsed State for Header */
        .header.collapsed .controls {
            max-height: 0;
            margin-top: 0;
        }
        .header.collapsed #header-toggle-btn {
            transform: rotate(-90deg);
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: var(--font-main);
            transition: all 0.2s ease;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary { background: var(--accent-primary); color: white; }
        .btn-primary:hover { filter: brightness(1.2); }
        
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--border-color); }

        /* --- Main Grid Layout --- */
        .grid-container {
            flex-grow: 1;
            overflow: auto; /* The single scrolling container */
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-secondary);
        }
        
        .table-grid {
            display: grid;
            grid-template-columns: 320px repeat(var(--playlist-count, 0), 100px);
        }

        .grid-cell {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }

        /* Header Cells */
        .header-cell {
            position: sticky;
            top: 0;
            background: var(--bg-tertiary);
            z-index: 10;
            font-weight: 600;
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .original-header-cell {
            position: sticky;
            left: 0;
            z-index: 20;
            justify-content: space-between;
        }
        
        .sort-header { cursor: pointer; user-select: none; }
        .sort-header:hover { color: var(--accent-primary); }
        .sort-indicator { font-size: 0.8em; }
        
        #search-input {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-main);
        }
        
        .playlist-header-cell {
            cursor: pointer;
            user-select: none;
        }
        .playlist-name {
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .playlist-song-count {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Body Cells */
        .song-cell {
            position: sticky;
            left: 0;
            background: var(--bg-secondary);
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .song-number {
            color: var(--text-secondary);
            font-size: 0.8em;
            width: 24px;
            text-align: center;
        }
        .song-details { flex-grow: 1; min-width: 0; }
        .song-name { font-weight: 600; }
        .song-artist { font-size: 0.85em; color: var(--text-secondary); }

        .checkbox-cell {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .checkbox {
            width: 20px; height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.1s ease-in-out;
        }
        .checkbox.checked {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }
        
        .hidden { display: none !important; }

        /* --- Context Menu --- */
        #context-menu {
            position: fixed;
            z-index: 1000;
            background: #333;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 5px 15px var(--shadow-color);
            display: none;
            flex-direction: column;
            gap: 4px;
        }
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            white-space: nowrap;
        }
        .context-menu-item:hover { background: var(--accent-primary); }
        .context-menu-item.danger:hover { background: #c0392b; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.2s; z-index: 2000;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--bg-secondary); padding: 24px; border-radius: 12px;
            width: calc(100% - 40px); max-width: 400px;
            border: 1px solid var(--border-color);
        }
        .modal-content h2 { margin-bottom: 16px; }
        .modal-input, .modal-textarea {
            width: 100%; padding: 12px; background: var(--bg-primary);
            border: 1px solid var(--border-color); border-radius: 8px;
            color: var(--text-primary); margin-bottom: 16px; font-size: 1em;
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px; }

        /* Scrollbar */
        ::-webkit-scrollbar { height: 12px; width: 12px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header" id="app-header">
            <div class="header-title-bar" onclick="toggleHeader()">
                <h1>Music Grid Organizer</h1>
                <button id="header-toggle-btn">â–¼</button>
            </div>
            <div class="controls">
                <textarea id="csv-import-area" class="btn-secondary" placeholder="Paste CSV to Import..." rows="1" style="width: 200px; resize: none;"></textarea>
                <button class="btn btn-secondary" onclick="document.getElementById('json-import-input').click()">ðŸ“¥ Import JSON</button>
                <input type="file" id="json-import-input" accept=".json" style="display:none;" onchange="importJSON(event)">
                <button class="btn btn-secondary" onclick="exportJSON()">ðŸ“¤ Export JSON</button>
                <button class="btn btn-primary" onclick="showCreatePlaylistModal()">âž• New Playlist</button>
            </div>
        </header>

        <main id="grid-container" class="grid-container">
            <!-- Grid will be rendered here by JS -->
        </main>
    </div>

    <div id="context-menu"></div>
    <div id="modal-container"></div>

    <script>
    let songs = [];
    let playlists = [];
    let sortConfig = { key: null, asc: true };
    let isHeaderCollapsed = false;

    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        renderGrid();
    });

    function saveState() {
        localStorage.setItem('musicGridState', JSON.stringify({ songs, playlists, sortConfig, isHeaderCollapsed }));
    }

    function loadState() {
        const state = JSON.parse(localStorage.getItem('musicGridState'));
        if (state) {
            songs = state.songs || [];
            playlists = state.playlists || [];
            sortConfig = state.sortConfig || { key: null, asc: true };
            isHeaderCollapsed = state.isHeaderCollapsed || false;
        }
        if (isHeaderCollapsed) {
            document.getElementById('app-header').classList.add('collapsed');
        }
    }

    // --- RENDERING ---
    function renderGrid() {
        const container = document.getElementById('grid-container');
        container.style.setProperty('--playlist-count', playlists.length);

        let gridHTML = '<div class="table-grid">';

        // HEADER ROW
        gridHTML += `
            <div class="header-cell original-header-cell">
                <div>
                    <span class="sort-header" onclick="sortSongs('name')">Track ${getSortIndicator('name')}</span> / 
                    <span class="sort-header" onclick="sortSongs('artist')">Artist ${getSortIndicator('artist')}</span>
                </div>
                <input id="search-input" type="search" placeholder="Search...">
            </div>
        `;
        playlists.forEach((p, i) => {
            gridHTML += `<div class="header-cell playlist-header-cell" data-index="${i}">
                <span class="playlist-name">${p.name}</span>
                <span class="playlist-song-count">${p.songIndices.length} songs</span>
            </div>`;
        });

        // BODY ROWS
        songs.forEach((song, sIndex) => {
            gridHTML += `<div class="grid-cell song-cell" data-row-index="${sIndex}">
                <span class="song-number">${sIndex + 1}</span>
                <div class="song-details">
                    <div class="song-name">${song.name}</div>
                    <div class="song-artist">${song.artist}</div>
                </div>
            </div>`;
            playlists.forEach((p, pIndex) => {
                const isChecked = p.songIndices.includes(sIndex);
                gridHTML += `<div class="grid-cell checkbox-cell" data-row-index="${sIndex}">
                    <div class="checkbox ${isChecked ? 'checked' : ''}" onclick="toggleSongInPlaylist(event, ${pIndex}, ${sIndex})"></div>
                </div>`;
            });
        });

        gridHTML += '</div>';
        container.innerHTML = gridHTML;
        
        setupEventListeners();
    }
    
    function getSortIndicator(key) {
        if (sortConfig.key !== key) return '';
        return sortConfig.asc ? 'â–²' : 'â–¼';
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        const searchInput = document.getElementById('search-input');
        if(searchInput) searchInput.addEventListener('input', filterSongs);

        const csvArea = document.getElementById('csv-import-area');
        if(csvArea) csvArea.addEventListener('paste', handleCSVPaste);
        
        let pressTimer;
        document.querySelectorAll('.playlist-header-cell').forEach(header => {
            header.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e.pageX, e.pageY, parseInt(header.dataset.index));
            });
            header.addEventListener('touchstart', (e) => {
                 pressTimer = setTimeout(() => {
                    e.preventDefault();
                    showContextMenu(e.touches[0].pageX, e.touches[0].pageY, parseInt(header.dataset.index));
                }, 500);
            });
            header.addEventListener('touchend', () => clearTimeout(pressTimer));
            header.addEventListener('touchmove', () => clearTimeout(pressTimer));
        });
        document.addEventListener('click', () => document.getElementById('context-menu').style.display = 'none');
    }

    // --- ACTIONS ---
    function toggleHeader() {
        isHeaderCollapsed = !isHeaderCollapsed;
        document.getElementById('app-header').classList.toggle('collapsed');
        saveState();
    }
    
    function sortSongs(key) {
        if (sortConfig.key === key) sortConfig.asc = !sortConfig.asc;
        else { sortConfig.key = key; sortConfig.asc = true; }

        songs.sort((a, b) => {
            const valA = a[key].toLowerCase();
            const valB = b[key].toLowerCase();
            if (valA < valB) return sortConfig.asc ? -1 : 1;
            if (valA > valB) return sortConfig.asc ? 1 : -1;
            return 0;
        });

        saveState();
        renderGrid();
    }

    function filterSongs(e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('.table-grid > .grid-cell[data-row-index]').forEach(cell => {
            const rowIndex = cell.dataset.rowIndex;
            const song = songs[rowIndex];
            const isVisible = song.name.toLowerCase().includes(searchTerm) || song.artist.toLowerCase().includes(searchTerm);
            cell.classList.toggle('hidden', !isVisible);
        });
    }

    function handleCSVPaste(e) {
        e.preventDefault();
        const csvText = e.clipboardData.getData('text');
        const lines = csvText.trim().split('\n');
        const newSongs = lines.map(line => {
            const columns = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            return {
                name: (columns[0] || 'Untitled').replace(/"/g, ''),
                artist: (columns[1] || 'Unknown Artist').replace(/"/g, ''),
            };
        }).filter(song => song.name !== 'Untitled');
        
        songs.push(...newSongs);
        e.target.value = '';
        saveState();
        renderGrid();
    }
    
    function toggleSongInPlaylist(event, pIndex, sIndex) {
        const checkbox = event.target;
        const playlist = playlists[pIndex];
        const songIndexInPlaylist = playlist.songIndices.indexOf(sIndex);

        if (songIndexInPlaylist > -1) {
            playlist.songIndices.splice(songIndexInPlaylist, 1);
            checkbox.classList.remove('checked');
        } else {
            playlist.songIndices.push(sIndex);
            checkbox.classList.add('checked');
        }
        
        const header = document.querySelector(`.playlist-header-cell[data-index="${pIndex}"] .playlist-song-count`);
        if(header) header.textContent = `${playlist.songIndices.length} songs`;
        
        saveState();
    }
    
    function createPlaylist(name) {
        if (!name) return;
        playlists.push({ name, songIndices: [] });
        saveState();
        renderGrid();
        closeModal();
    }
    
    function clonePlaylist(pIndex) {
        const original = playlists[pIndex];
        const newPlaylist = {
            name: `${original.name} (Copy)`,
            songIndices: [...original.songIndices]
        };
        playlists.push(newPlaylist);
        saveState();
        renderGrid();
    }
    
    function exportPlaylistCSV(pIndex) {
        const playlist = playlists[pIndex];
        if (playlist.songIndices.length === 0) {
            alert("Playlist is empty. Nothing to export.");
            return;
        }
        const csvHeader = "Track,Artist\n";
        const csvRows = playlist.songIndices.map(songIndex => {
            const song = songs[songIndex];
            const track = `"${song.name.replace(/"/g, '""')}"`;
            const artist = `"${song.artist.replace(/"/g, '""')}"`;
            return `${track},${artist}`;
        }).join("\n");
        
        const csvContent = csvHeader + csvRows;
        
        // Use document.execCommand for wider compatibility in WebViews
        const textArea = document.createElement("textarea");
        textArea.value = csvContent;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            alert(`"${playlist.name}" copied to clipboard as CSV!`);
        } catch (err) {
            alert('Failed to copy. Your browser may not support this feature.');
        }
        document.body.removeChild(textArea);
    }

    function deletePlaylist(pIndex) {
        if (confirm(`Are you sure you want to delete "${playlists[pIndex].name}"?`)) {
            playlists.splice(pIndex, 1);
            saveState();
            renderGrid();
        }
    }
    
    function exportJSON() {
        const dataStr = JSON.stringify({ songs, playlists, sortConfig, isHeaderCollapsed }, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `music-grid-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }
    
    function importJSON(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                songs = data.songs || [];
                playlists = data.playlists || [];
                sortConfig = data.sortConfig || { key: null, asc: true };
                isHeaderCollapsed = data.isHeaderCollapsed || false;
                saveState();
                renderGrid();
            } catch (error) {
                alert('Error importing file.');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }
    
    // --- UI HELPERS ---
    function showContextMenu(x, y, pIndex) {
        const menu = document.getElementById('context-menu');
        menu.style.top = `${y}px`;
        menu.style.left = `${x}px`;
        menu.style.display = 'flex';
        menu.innerHTML = `
            <div class="context-menu-item" onclick="clonePlaylist(${pIndex})">Clone Playlist</div>
            <div class="context-menu-item" onclick="exportPlaylistCSV(${pIndex})">Export to CSV</div>
            <div class="context-menu-item danger" onclick="deletePlaylist(${pIndex})">Delete Playlist</div>
        `;
    }

    function showCreatePlaylistModal() {
        showModal(`
            <h2>New Playlist</h2>
            <input id="playlist-name-input" class="modal-input" placeholder="Playlist Name">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createPlaylist(document.getElementById('playlist-name-input').value)">Create</button>
            </div>
        `);
    }

    function showModal(content) {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.innerHTML = `
            <div class="modal-overlay" onclick="closeModal()">
                <div class="modal-content" onclick="event.stopPropagation()">${content}</div>
            </div>
        `;
        setTimeout(() => document.querySelector('.modal-overlay').classList.add('visible'), 10);
    }

    function closeModal() {
        const overlay = document.querySelector('.modal-overlay');
        if (overlay) {
            overlay.classList.remove('visible');
            overlay.addEventListener('transitionend', () => overlay.remove(), { once: true });
        }
    }
    
    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(registration => {
                console.log('ServiceWorker registration successful');
            }).catch(err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
    </script>
</body>
</html>
